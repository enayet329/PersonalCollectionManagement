CREATE TABLE Users (
    Id UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID(),
    Username NVARCHAR(50) NOT NULL UNIQUE,
    Email NVARCHAR(MAX) NOT NULL UNIQUE,
    PasswordHash NVARCHAR(MAX) NOT NULL,
    ImageURL NVARCHAR(MAX),
    PreferredLanguage NVARCHAR(3) DEFAULT 'en',
    PreferredThemeDark BIT DEFAULT 0,
    IsAdmin BIT DEFAULT 0,
    IsBlocked BIT DEFAULT 0
);

CREATE UNIQUE INDEX IX_Users_Username ON Users (Username);
CREATE UNIQUE INDEX IX_Users_Email ON Users (Email);

CREATE TABLE Collections (
    Id UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID(),
    Name NVARCHAR(100) NOT NULL,
    Description NVARCHAR(MAX),
    Topic NVARCHAR(MAX),
    ImageUrl NVARCHAR(MAX),
    UserId UNIQUEIDENTIFIER NOT NULL,
    FOREIGN KEY (UserId) REFERENCES Users(Id) ON DELETE CASCADE
);

CREATE UNIQUE INDEX IX_Collections_Id ON Collections (Id);

CREATE TABLE Items (
    Id UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID(),
    Name NVARCHAR(100) NOT NULL,
    ImgUrl NVARCHAR(MAX),
    Description NVARCHAR(MAX),
    DateAdded DATETIME NOT NULL DEFAULT GETDATE(),
    CollectionId UNIQUEIDENTIFIER NOT NULL,
    FOREIGN KEY (CollectionId) REFERENCES Collections(Id) ON DELETE CASCADE
);

CREATE UNIQUE INDEX IX_Items_Id ON Items (Id);

CREATE TABLE Comments (
    Id UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID(),
    Content NVARCHAR(MAX) NOT NULL,
    CreatedAt DATETIME NOT NULL DEFAULT GETDATE(),
    UserId UNIQUEIDENTIFIER NOT NULL,
    ItemId UNIQUEIDENTIFIER NOT NULL,
    FOREIGN KEY (UserId) REFERENCES Users(Id) ON DELETE RESTRICT,
    FOREIGN KEY (ItemId) REFERENCES Items(Id) ON DELETE CASCADE
);

CREATE UNIQUE INDEX IX_Comments_Id ON Comments (Id);

CREATE TABLE Likes (
    Id UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID(),
    UserId UNIQUEIDENTIFIER NOT NULL,
    ItemId UNIQUEIDENTIFIER NOT NULL,
    FOREIGN KEY (UserId) REFERENCES Users(Id) ON DELETE RESTRICT,
    FOREIGN KEY (ItemId) REFERENCES Items(Id) ON DELETE CASCADE,
    UNIQUE(UserId, ItemId)
);

CREATE UNIQUE INDEX IX_Likes_UserId_ItemId ON Likes (UserId, ItemId);

CREATE TABLE Tags (
    Id UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID(),
    Name NVARCHAR(50) NOT NULL
);

CREATE UNIQUE INDEX IX_Tags_Id ON Tags (Id);

CREATE TABLE ItemTags (
    ItemId UNIQUEIDENTIFIER NOT NULL,
    TagId UNIQUEIDENTIFIER NOT NULL,
    FOREIGN KEY (ItemId) REFERENCES Items(Id) ON DELETE CASCADE,
    FOREIGN KEY (TagId) REFERENCES Tags(Id) ON DELETE CASCADE,
    PRIMARY KEY (ItemId, TagId)
);

CREATE UNIQUE INDEX IX_ItemTags_ItemId_TagId ON ItemTags (ItemId, TagId);

CREATE TABLE CustomFields (
    Id UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID(),
    Name NVARCHAR(100) NOT NULL,
    FieldType NVARCHAR(50) NOT NULL,
    CollectionId UNIQUEIDENTIFIER NOT NULL,
    FOREIGN KEY (CollectionId) REFERENCES Collections(Id) ON DELETE CASCADE
);

CREATE UNIQUE INDEX IX_CustomFields_Id ON CustomFields (Id);

CREATE TABLE CustomFieldValues (
    Id UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID(),
    Value NVARCHAR(MAX) NOT NULL,
    CustomFieldId UNIQUEIDENTIFIER NOT NULL,
    ItemId UNIQUEIDENTIFIER NOT NULL,
    FOREIGN KEY (CustomFieldId) REFERENCES CustomFields(Id) ON DELETE CASCADE,
    FOREIGN KEY (ItemId) REFERENCES Items(Id) ON DELETE NO ACTION,
    UNIQUE(CustomFieldId, ItemId)
);

CREATE UNIQUE INDEX IX_CustomFieldValues_CustomFieldId ON CustomFieldValues (CustomFieldId);

CREATE TABLE RefreshTokens (
    Id UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID(),
    Token NVARCHAR(MAX) NOT NULL,
    Expires DATETIME NOT NULL,
    Created DATETIME NOT NULL,
    Revoked DATETIME,
    UserId UNIQUEIDENTIFIER NOT NULL,
    FOREIGN KEY (UserId) REFERENCES Users(Id) ON DELETE CASCADE
);

CREATE UNIQUE INDEX IX_RefreshTokens_Id ON RefreshTokens (Id);
